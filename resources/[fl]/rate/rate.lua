local limiter = {}

local rateLimit = 10

local event = {
    "3dme:shareDisplay",
    "ClientDiscord",
    "InteractSound_SV:PlayWithinDistance",
    "ServerEmoteRequest",
    "ServerValidEmote",
    "_chat:messageEntered",
    "ambulance:revive",
    "ambulance:setDeathStatus",
    "baseevents:enteredVehicle",
    "baseevents:enteringAborted",
    "fl_bank:hackAtm",
    "baseevents:enteringVehicle",
    "baseevents:leftVehicle",
    "baseevents:onPlayerDied",
    "baseevents:onPlayerKilled",
    "baseevents:onPlayerWasted",
    "chat:init",
    "checkreportadmin",
    "dp:CheckVersion",
    "dp:ServerKeybindCreate",
    "dp:ServerKeybindExist",
    "dp:ServerKeybindGrab",
    "dp:ServerKeybindUpdate",
    "dp:SyncPtfx",
    "es_extended:displayReports",
    "es_mapper:addObjectToSave",
    "es_mapper:beginSaveObjects",
    "es_mapper:endSaveObjects",
    "es_mapper:loadObjects",
    "esx-qalle-needs:sync",
    "esx:deleteEntity",
    "esx:deleteEntityTable",
    "esx:discardInventoryItem",
    "esx:giveInventoryItem",
    "esx:onPickup",
    "esx:onPlayerDeath",
    "esx:onPlayerJoined",
    "esx:onPlayerSpawn",
    "esx:perquis",
    "esx:removeInventoryItem",
    "esx:saveplayer",
    "esx:updateWeight",
    "esx:useItem",
    "esx_outlawalert:banka-arac",
    "esx_policedog:hasClosestDrugs",
    "esx_skin:responseSaveSkin",
    "esx_skin:save",
    "esx_truck_inventory:AddVehicleList",
    "esx_truck_inventory:RemoveVehicleList",
    "esx_truck_inventory:addInventoryItem",
    "esx_truck_inventory:getInventory",
    "esx_truck_inventory:getOwnedVehicule",
    "esx_truck_inventory:removeInventoryItem",
    "exploit:43",
    "exploit:god",
    "exploit:notWideScreen",
    "fizzfau-moneytruck:checkRob",
    "fizzfau-moneytruck:onPlayerDeath",
    "fizzfau-moneytruck:playerSpawned",
    "fizzfau-moneytruck:server:startRob",
    "fl_accessories:pay",
    "fl_accessories:removeMaskOf",
    "fl_advancedgarage:pay",
    "fl_advancedgarage:responseVehicleState",
    "fl_advancedgarage:setVehicleState",
    "fl_aircraftshop:setVehicleOwned",
    "fl_ambulancejob:giveItem",
    "fl_ambulancejob:heal",
    "fl_ambulancejob:putInVehicle",
    "fl_ambulancejob:removeItem",
    "fl_ambulancejob:revive",
    "fl_ambulancejob:setDeathStatus",
    "fl_ambulancejob:svsearch",
    "fl_ammunation:givelicence",
    "fl_ammunation:startCraft",
    "fl_ammunation:startHarvest",
    "fl_ammunation:startHarvest2",
    "fl_ammunation:startHarvestMunition",
    "fl_ammunation:startHarvestMunition2",
    "fl_ammunation:startVenteMunition",
    "fl_ammunation:stopCraft",
    "fl_ammunation:stopHarvest",
    "fl_ammunation:stopHarvest2",
    "fl_ammunation:stopHarvest3",
    "fl_ammunation:stopHarvestMunition",
    "fl_ammunation:stopHarvestMunition2",
    "fl_ammunation:stopTransformMunition",
    "fl_ammunation:stopVenteMunition",
    "fl_animals:consumePetFood",
    "fl_animals:petDied",
    "fl_appels:ClearApp",
    "fl_appels:Zebi",
    "fl_bank:customerBlueBookDeposit",
    "fl_bank:customerBlueBookWithdraw",
    "fl_bank:deposit",
    "fl_bank:destroyAtm",
    "fl_bank:hackAtm",
    "fl_bank:rob",
    "fl_bank:toofar",
    "fl_bank:transfer",
    "fl_bank:withdraw",
    "fl_bikeshop:addToList",
    "fl_bikeshop:addVehicleToStock",
    "fl_bikeshop:rentVehicle",
    "fl_bikeshop:returnProvider",
    "fl_bikeshop:sellVehicle",
    "fl_bikeshop:setVehicleForAllPlayers",
    "fl_bikeshop:setVehicleOwnedPlayerId",
    "fl_billing:sendBill",
    "fl_boatshop:setVehicleOwned",
    "fl_burglary:globalEvent",
    "fl_coiffeur:change",
    "fl_coiffeur:getSkin",
    "fl_coiffeur:resetSkin",
    "fl_coiffeur:save",
    "fl_coiffeur:setSkin",
    "fl_controlvehicle:changeOwner",
    "fl_controlvehicle:deleteKeyJobs",
    "fl_controlvehicle:deleteVehicle",
    "fl_controlvehicle:giveKey",
    "fl_controlvehicle:lendKey",
    "fl_controlvehicle:registerKey",
    "fl_core:TargetClient",
    "fl_core:anim:stop",
    "fl_core:anim:sync",
    "fl_core:police:code",
    "fl_dmvschool:addLicense",
    "fl_dmvschool:createLicensePoint",
    "fl_dmvschool:pay",
    "fl_dmvschool:removePoints",
    "fl_dmvschool:showToOther",
    "fl_doorlock:updateState",
    "fl_drugs:start",
    "fl_drugs:stop",
    "fl_drugsPNJ:payChouff",
    "fl_drugsPNJ:toggleAttack",
    "fl_eden_clotheshop:deleteOutfit",
    "fl_eden_clotheshop:pay",
    "fl_eden_clotheshop:removeOutfit",
    "fl_eden_clotheshop:renameOutfit",
    "fl_eden_clotheshop:saveOutfit",
    "fl_faction:confiscatePlayerItem",
    "fl_factions:getStockItems",
    "fl_factions:mowHead",
    "fl_factions:putStockItems",
    "fl_garbagecrew:bagdumped",
    "fl_garbagecrew:bagremoval",
    "fl_garbagecrew:movetruckcount",
    "fl_garbagecrew:setconfig",
    "fl_garbagecrew:setworkers",
    "fl_garbagecrew:unknownlocation",
    "fl_greenmotors:buyMod",
    "fl_greenmotors:refreshOwnedVehicle",
    "fl_hifi:playMusic",
    "fl_hifi:removeHifi",
    "fl_hifi:setDistance",
    "fl_hifi:setVolume",
    "fl_hifi:stopMusic",
    "fl_hookah:pay",
    "fl_identity:setIdentity",
    "fl_joblisting:setJob",
    "fl_jobs:caution",
    "fl_jobs:daymson:startCraftDaymson",
    "fl_jobs:daymson:startHarvestDaymson",
    "fl_jobs:daymson:startSellDaymson",
    "fl_jobs:daymson:stopCraftDaymson",
    "fl_jobs:daymson:stopHarvestDaymson",
    "fl_jobs:daymson:stopSellDaymson",
    "fl_jobs:giveBackCautionInCaseOfDrop",
    "fl_jobs:requestPlayerData",
    "fl_jobs:setCautionInCaseOfDrop",
    "fl_jobs:startWork",
    "fl_jobs:stopWork",
    "fl_jobs:taxi:successTaxi",
    "fl_jobs:vigneron:startCraftVigneron",
    "fl_jobs:vigneron:startCraftVigneron2",
    "fl_jobs:vigneron:startHarvestVigneron",
    "fl_jobs:vigneron:startSellVigneron",
    "fl_jobs:vigneron:startSellVigneron2",
    "fl_jobs:vigneron:stopCraftVigneron",
    "fl_jobs:vigneron:stopCraftVigneron2",
    "fl_jobs:vigneron:stopHarvestVigneron",
    "fl_jobs:vigneron:stopSellVigneron",
    "fl_jobs:vigneron:stopSellVigneron2",
    "fl_license:addLicense",
    "fl_lscustom:buyMod",
    "fl_lscustom:buyModMechanic",
    "fl_lscustom:refreshOwnedVehicle",
    "fl_mechanic:onNPCJobCompleted",
    "fl_mechanic:onNPCJobMissionCompleted",
    "fl_mechanic:startCraft",
    "fl_mechanic:startCraft2",
    "fl_mechanic:startCraft3",
    "fl_mechanic:startHarvest",
    "fl_mechanic:startHarvest2",
    "fl_mechanic:startHarvest3",
    "fl_mechanic:stopCraft",
    "fl_mechanic:stopCraft2",
    "fl_mechanic:stopCraft3",
    "fl_mechanic:stopHarvest",
    "fl_mechanic:stopHarvest2",
    "fl_mechanic:stopHarvest3",
    "fl_menu:Admin_Move",
    "fl_menu:Admin_give",
    "fl_menu:Boss_destituerplayer",
    "fl_menu:Boss_promouvoirplayer",
    "fl_menu:Boss_recruterplayer",
    "fl_menu:Boss_virerplayer",
    "fl_npcdrugsales:sell",
    "fl_npcdrugsales:trigger",
    "fl_particles:disable",
    "fl_particles:disableall",
    "fl_particles:sync",
    "fl_phone:acceptCall",
    "fl_phone:addContact",
    "fl_phone:allUpdate",
    "fl_phone:appelsDeleteAllHistorique",
    "fl_phone:appelsDeleteHistorique",
    "fl_phone:deleteALL",
    "fl_phone:deleteAllMessage",
    "fl_phone:deleteContact",
    "fl_phone:deleteMessage",
    "fl_phone:deleteMessageNumber",
    "fl_phone:ignoreCall",
    "fl_phone:rejectCall",
    "fl_phone:sendMessage",
    "fl_phone:sendMessageToJob",
    "fl_phone:setReadMessageNumber",
    "fl_phone:startCall",
    "fl_phone:tchat_addMessage",
    "fl_phone:tchat_channel",
    "fl_phone:updateContact",
    "fl_policejob:OutVehicle",
    "fl_policejob:OutVehicleErrorResponse",
    "fl_policejob:addSpeedzone",
    "fl_policejob:drag",
    "fl_policejob:dragErrorResponse",
    "fl_policejob:handcuff",
    "fl_policejob:message",
    "fl_policejob:putBracelet",
    "fl_policejob:putInVehicle",
    "fl_policejob:removeBracelet",
    "fl_policejob:removeSpeedzone",
    "fl_property:BeUnstuck",
    "fl_property:DelParking",
    "fl_property:EnterInInstance",
    "fl_property:EnterInPropAfterWanted",
    "fl_property:ExitInInstance",
    "fl_property:InviteInYourInstance",
    "fl_property:InviteToVisit",
    "fl_property:VisitProperty",
    "fl_property:definedPropertyAsSociety",
    "fl_property:deleteLastProperty",
    "fl_property:getItem",
    "fl_property:patronmess",
    "fl_property:putItem",
    "fl_property:removeOwnedPropertyId",
    "fl_property:resetPropertyAsSociety",
    "fl_property:saveLastProperty",
    "fl_property:setParking",
    "fl_property:swag",
    "fl_property:updateOtherKeys",
    "fl_property:wantToEnter",
    "fl_property_util:save",
    "fl_pub:personnalisée",
    "fl_realestateagentjob:",
    "fl_realestateagentjob:buySelf",
    "fl_realestateagentjob:revoke",
    "fl_sheriffjob:OutVehicle",
    "fl_sheriffjob:OutVehicleErrorResponse",
    "fl_sheriffjob:addSpeedzone",
    "fl_sheriffjob:drag",
    "fl_sheriffjob:dragErrorResponse",
    "fl_sheriffjob:handcuff",
    "fl_sheriffjob:message",
    "fl_sheriffjob:putBracelet",
    "fl_sheriffjob:putInVehicle",
    "fl_sheriffjob:removeBracelet",
    "fl_sheriffjob:removeSpeedzone",
    "fl_sheriffjob:requestarrest",
    "fl_sheriffjob:requestrelease",
    "fl_sheriffjob:spawned",
    "fl_shops:buyItem",
    "fl_shops:pickUp",
    "fl_shops:rob",
    "fl_simcard:buyPhone",
    "fl_simcard:buySimcard",
    "fl_simcard:changeNumber",
    "fl_simcard:dupeSim",
    "fl_simcard:toggleSim",
    "fl_simcard:useCallCredit",
    "fl_simcard:useSmsCredit",
    "fl_sit:leavePlace",
    "fl_sit:takePlace",
    "fl_sixt:rentVehicle",
    "fl_sixt:returnProvider",
    "fl_sixt:setVehicleForAllPlayers",
    "fl_sixt:setVehicleOwnedPlayerId",
    "fl_skin:save",
    "fl_society",
    "fl_society:adFromClient",
    "fl_society:depositMoney",
    "fl_society:getStockItem",
    "fl_society:putStockItem",
    "fl_society:withdrawMoney",
    "fl_societyfaction:depositMoney",
    "fl_societyfaction:putVehicleInGarageFaction",
    "fl_societyfaction:removeVehicleFromGarageFaction",
    "fl_societyfaction:withdrawMoney",
    "fl_speedradar:destroyedRadar",
    "fl_speedradar:flashed",
    "fl_speedradar:requestSyncRadars",
    "fl_status:update",
    "fl_tattooshop:change",
    "fl_tattooshop:getSkin",
    "fl_tattooshop:purchaseTattoo",
    "fl_tattooshop:resetSkin",
    "fl_tattooshop:setPedSkin",
    "fl_tattooshop:setSkin",
    "fl_unicornjob:buyItem",
    "fl_unicornjob:craftingCoktails",
    "fl_unicornjob:startSell",
    "fl_unicornjob:stopSell",
    "fl_useitem:bong",
    "fl_vangelico_robbery:endrob",
    "fl_vangelico_robbery:gioielli1",
    "fl_vangelico_robbery:rob",
    "fl_vangelico_robbery:toofar",
    "fl_vehicleshop:addToList",
    "fl_vehicleshop:rentVehicle",
    "fl_vehicleshop:returnProvider",
    "fl_vehicleshop:sellVehicle",
    "fl_vehicleshop:setVehicleForAllPlayers",
    "fl_vehicleshop:setVehicleOwnedPlayerId",
    "fl_washmoney:getMoneyWashed",
    "fl_washmoney:putMoneyInWashing",
    "fl_washmoney:rentMachine",
    "fl_xmas:giveSnowball",
    "fuel:giveJerrycan",
    "fuel:pay",
    "h4ci_report:ajoutreport",
    "h4ci_report:supprimereport",
    "heli:spotlight",
    "iCore:sendCallMsg",
    "iCore:tookCall",
    "jsfour-idcard:open",
    "jsfour-idcard:openCustom",
    "lester:vendita",
    "modeo:UpdateName",
    "modeo:UpdatePrenom",
    "modeo:UpdateTaille",
    "modeo:Updatedate",
    "modeo:Updatesex",
    "nwx:carry",
    "nwx:carryStop",
    "nwx:tryTackle",
    "nwx_tabac:startCraftTabac",
    "nwx_tabac:startCraftTabac2",
    "nwx_tabac:startCraftTabac3",
    "nwx_tabac:startHarvestTabac",
    "nwx_tabac:startSellTabac",
    "nwx_tabac:startSellTabac2",
    "nwx_tabac:stopCraftTabac",
    "nwx_tabac:stopCraftTabac2",
    "nwx_tabac:stopCraftTabac3",
    "nwx_tabac:stopHarvestTabac",
    "nwx_tabac:stopSellTabac",
    "nwx_tabac:stopSellTabac2",
    "playerDied",
    "playerShotWeapon",
    "pma-voice:setPlayerCall",
    "pma-voice:setPlayerRadio",
    "pma-voice:setTalkingOnCall",
    "pma-voice:setTalkingOnRadio",
    "polyzone:printBox",
    "polyzone:printCircle",
    "polyzone:printPoly",
    "pz_admin:StaffOn",
    "pz_admin:addReport",
    "pz_admin:ban",
    "pz_admin:bring",
    "pz_admin:bringplayer",
    "pz_admin:canUse",
    "pz_admin:getItems",
    "pz_admin:kick",
    "pz_admin:message",
    "pz_admin:remb",
    "pz_admin:removeReport",
    "pz_admin:revive",
    "pz_admin:takeReport",
    "rocademption:playerConnected",
    "ruben:achat",
    "ruben:sendMessageWebhook",
    "sheriff:PriseEtFinservice",
    "sheriff:renfort",
    "vMenu:RequestPermissions",
    "vSync:requestSync",
}

local function netLog(s)
    print(string.format('NET-STATE - [%s]: %s^7', os.date("%Y-%m-%d %H:%M:%S", os.time()), s))
end

for i = 1, #event do
    local eventName = event[i]

    RegisterServerEvent(eventName)
    AddEventHandler(eventName, function()
        local playerId = tonumber(source)
        if not playerId or playerId == 0 then return end
        local timerNow = GetGameTimer()

        if not limiter[playerId] then limiter[playerId] = {} end

        local limit = limiter[playerId][eventName]

        if not limit then
            limiter[playerId][eventName] = { counter = 1, started = timerNow }
            return
        else
            if (timerNow - limit.started) >= 1000 then
                limit.counter = 1
                limit.started = timerNow
                return
            else
                limit.counter = limit.counter + 1
            end
        end

        if limit.counter > rateLimit then
            netLog(string.format('User [%i] %s exceeded rate-limit - INFO : %s [%i/%i]', playerId, GetPlayerName(playerId), eventName, limit.counter, rateLimit))
            DropPlayer(playerId, "Vous n'êtes pas autorisé à faire autant de requêtes.")
        end
    end)
end

AddEventHandler('playerDropped', function(reason)
    if limiter[source] then
        limiter[source] = nil
    end
end)